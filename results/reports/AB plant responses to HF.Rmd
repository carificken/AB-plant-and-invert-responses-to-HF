---
title: "AB plant respones to HF"
author: "Cari D. Ficken"
date: "`r Sys.Date()`"
output:
  pdf_document: default
  html_document:
    df_print: paged
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F, message=F, warning=F)
library(tidyverse) 
library(vegan)
library(ggrepel)
library(cowplot)
library(lme4)
```

The goal of this project is to examine how wetland plant communities repond to disturbance. 

# 1. Load data; calculate CSI

Loading vegetation data (presence/absence) and HF data (% total human development in each plot). Calculating a species specialization index and community specialization index based on the variability in species cumulative occurrences across the the binned HF gradient.

```{r load data}
# load veg data
veg_pa <- read.csv("/Users/cari/Desktop/Waterloo/AB plant and invert responses to HF/data/cleaned/ABMI veg cleaned.csv")
# load HF data 
hf <- read.csv("/Users/cari/Desktop/Waterloo/AB plant and invert responses to HF/data/cleaned/Alb wetlands HF.csv") 
hf_tot <- hf %>% group_by(Protocol, NRNAME, WetlandType, Site, Year) %>% summarize(totdist_percent=sum(Area_percent))
```

```{r calc SSI}
  # first create 10 bins
  hf_tot$HFbin <- ntile(hf_tot$totdist_percent, n=10) 
  
  veg_hf <- left_join(veg_pa, hf_tot, by=c("NRNAME", "WetlandType", "Protocol", "Site", "Year"))

  # calc occurrence freq of each sp in each bin
  occfreq_HFbin <- veg_hf %>% 
      group_by(HFbin,Species) %>% 
      summarize(occ_freq=sum(PA))
  
  # exclude species which occur only 1x - they will have high sensitivity
  occfreq_HFbin <- occfreq_HFbin %>% 
    arrange(Species) %>% 
    group_by(Species) %>% 
    mutate(cum_occ_freq = sum(occ_freq)) %>% 
    filter(cum_occ_freq>1) %>% 
    select(-cum_occ_freq)
  
  # expand the bin categories so each species has an occ freq value for every bin #1:10
  occfreq_HFbin <- occfreq_HFbin %>% 
    spread(key=HFbin, value=occ_freq) %>% 
    gather(key=HFbin, value=occ_freq, 2:ncol(.)) %>% 
    mutate(occ_freq=replace_na(occ_freq,0))
  
  # now calculate species sensitivitiy index (=CV) for each species across the gradient of HF bins
  sp_SSI <- occfreq_HFbin %>% 
    group_by(Species) %>%
    summarize(CV=sd(occ_freq)/mean(occ_freq))
```

```{r calc CSI}
  veg_CSI_HF <- left_join(veg_pa, sp_SSI)
  veg_CSI_HF <- veg_CSI_HF %>% 
    group_by(Protocol,NRNAME, WetlandType,Site,Year) %>% 
    summarize(CSI=mean(CV, na.rm = T)) # 32 sites have na value for at least 1 sp
  
  veg_CSI_HF <- left_join(veg_CSI_HF,hf_tot, by=c("NRNAME", "WetlandType", "Protocol", "Site", "Year")) 
```

# 2. How does sp richness vary across disturbance gradient?

Species richrichess peaks at intermediate disturbance levels. Note that Protocol (i.e. wetland vs terrestrial) is a significant predictor of species richness; we need to do something about this.

```{r richness vs dist}
  spR <- veg_pa %>% group_by(Protocol, NRNAME, WetlandType, Site, Year) %>% summarize(rich=sum(PA))
  spR <- inner_join(spR, hf_tot, by=c("Protocol", "NRNAME", "WetlandType", "Site", "Year"))
  
  m.poly.raneff.rich <- lmer(rich ~ poly(totdist_percent,2) + 
                          (1|paste(spR$Protocol, spR$Site, sep="_")), 
                        data=spR,
                        REML = F)
  m.poly.raneff.rich.protocol <- 
    lmer(rich ~ poly(totdist_percent,2)*Protocol + 
           (1|paste(spR$Protocol, spR$Site, sep="_")), 
                             data=spR,
                             REML = F)
  # AIC(m.poly.raneff.rich, m.poly.raneff.rich.protocol)
  
  ggplot(spR, aes(x=totdist_percent, y=rich)) +
    labs(x="Total Human Development (%)", y="Species Richness") +
    geom_point(alpha=0.5) + 
    geom_smooth(method="lm", formula=y~poly(x,2), se=F) +
    # facet_wrap(~Protocol) +
    theme_classic() 
```

# 3. Do communities at low and high HF differ?

Communities at low and high end of HF gradient show similar plant diversity (richness), but are these communities compositionally different? Yes, MRPP test shows significant difference between these groups and the ordination visualizes this. 

Species most strongly associated with sites in the low HF bin (bin 1):

* _Rhodondendron tomentosum_: marsh labrador tea
* _Eriophorum scheuchzeri_: white cotton grass
* _Carex oligosperma_: fewseed sedge
* _Drosera anglica_: English sundew
* _Scheuchzeria palustris: Rannoch-rush

Species most strongly associated with sites in the highest HF bin (bin 10):

* _Euphorbia serpyllifolia_: thymeleaf sandmat
* _Avena sativa_: common oat
* _Polygonum ramosissimum_: bushy knotweed
* _Potentilla supina_: bushy cinquefoil
* _Bromus commutatus_: meadow brome or hairy chess

```{r results='hide'}
library(ggrepel)

# ordinations of the highest and lowest disturbed sites
veg_hf2 <- veg_hf %>% 
  select(NRNAME, Protocol, WetlandType, Site, Year, Species, PA)
veg_hf2 <- veg_hf2 %>% 
  spread(key=Species, value=PA) %>% 
  gather(key=Species, value=PA, 6:ncol(.)) %>% 
  replace_na(list(PA=0)) %>% 
  spread(key=Species, value=PA) 

veg_hf2 <- left_join(veg_hf2, select(hf_tot, -totdist_percent), by=c("NRNAME", "Protocol", "WetlandType", "Site", "Year"))
veg_hf2 <- veg_hf2 %>% filter(HFbin==1 | HFbin==10) %>% select(NRNAME, Protocol, WetlandType, Site, Year, HFbin, everything())

# distance matrix
veg_d <- vegdist(veg_hf2[,7:ncol(veg_hf2)], method="jaccard", binary=T)

veg.nmds4 <- metaMDS(veg_hf2[,7:ncol(veg_hf2)], distance="jaccard", binary=T, k=4,trymax=100)
```

```{r}
# check for sig diffs among groups
# mrpp(veg_d, grouping=as.factor(veg_hf2$HFbin)) # sig diff between groups based on mean score

# extract site scores and convert to df
veg.scores <- data.frame(scores(veg.nmds4, "sites"))
# add in protocol, site, year, 
veg.scores$Protocol <- as.factor(veg_hf2$Protocol)
veg.scores$Site <- veg_hf2$Site
veg.scores$Year <- veg_hf2$Year
veg.scores$NRNAME <- veg_hf2$NRNAME
veg.scores$HFbin <- veg_hf2$HFbin

spscores <- data.frame(scores(veg.nmds4, display="species"))

spscores$Species <- rownames(spscores)

impsp_5 <- bind_rows(top_n(spscores, 5, wt=NMDS1),
                     top_n(spscores, -5, wt=NMDS1))

spdriversp <- ggplot(data=impsp_5) +
  geom_point(data=veg.scores, 
             aes(x=NMDS1, y=NMDS2, 
                 color=as.factor(HFbin), 
                 shape=as.factor(HFbin)),
             size=3) +
  stat_ellipse(data=veg.scores, 
               aes(x=NMDS1, y=NMDS2, 
                   color=as.factor(HFbin))) +
  scale_color_brewer(palette = "Dark2", name="HF Bin") +
  scale_shape_manual(values=c(15,16), name="HF Bin") +
  geom_segment(aes(x=0,y=0,xend=NMDS1,yend=NMDS2), 
               color=1,
               arrow=arrow(length=unit(0.3, "cm"))) +
  geom_label_repel(aes(x=NMDS1,y=NMDS2,label=Species),
                   box.padding=1, size=3.5) +
  theme(legend.position="top")
spdriversp
```

# 4. Do communities along HF gradient differ in their specialization? 

Community specialization index (CSI) is a measure of the mean niche breadth of species within a community. Species which occur with high frequency under a narrow HF are highly specialized and have a narrow niche bread; conversely, species which occur across a range of HF levels are less specialized and have a broader niche breadth. 

Models with random effects (linear, 2nd order polynomial, 3rd order polynomial) show no effect of including a Protocol x Site unique ID random effect. Linear models find that the quadratic model describes CSI better than the linear model.

Plant communities show a U-shaped relationship between CSI and HF, indicating that communities at high and low develoment intensities are composed of more specialized species than communities at intermediate develoment intensities. We speculate that communities at intermediate development intensities encompass the edges of two, different "preferred" habitats - either higher or lower development intensities. 

Communities at high and low develoment intensities both are composed of species with high specialization to that respective habitat. Species at low development intensities may be so-called "competitive" species, with a high capacity to catpure limiting soil nutrients (or they could also be stress-tolerant species, if climate is the stronger limiting factor). In contrast, species at high development intesnities may be so-called "ruderal" species, which are r-selected species with high dispersal capacity.

```{r overall realtionship}
# relationship between veg community specialization and HF
  m.linear <- lm(CSI ~ totdist_percent, data=veg_CSI_HF)
  # summary(m.linear)
  m.poly <- lm(CSI ~ poly(totdist_percent,2), data=veg_CSI_HF)
  summary(m.poly)
  # AIC(m.linear, m.poly)
  
  ggplot(veg_CSI_HF,aes(x=totdist_percent,y=CSI)) +
    labs(x="Total Human Development (%)", y="CSI to human develpoment") +
    geom_point(alpha=0.5) + 
    geom_smooth(method="lm", formula=y~poly(x,2), se=F, color="blue") +
    geom_smooth(method="lm", se=F, linetype="dashed", color="red") +
    annotate(geom="text", x=0, y=2, 
             label="Poly: R2 = 0.28, AIC = -2408, p < 0.001", color="blue", size=5, hjust=0) +
    annotate(geom="text", x=0, y=1.9, 
             label="Linear: R2 = 0.24, AIC = -2301, p < 0.001", color="red", size=5, hjust=0) +
    theme_classic() +
    theme(legend.position = "none")
```

# 5. How does the proportion of exotic species contribute to these patterns?

```{r load exotics data}
exotics <- read.csv("/Users/cari/Desktop/Waterloo/AB plant and invert responses to HF/data/cleaned/exotic_plants_ab.csv", sep=";")

hf_exot <- left_join(veg_hf, exotics, by=c("Species"="SPECIES")) %>% select(-TYPE)
hf_exot <- hf_exot %>% 
  group_by(Protocol, Site,Year,totdist_percent, ORIGIN) %>% 
  tally() %>% 
  spread(key=ORIGIN, value=n) %>% 
  replace_na(list(Exotic=0, Native=0,`Unknown/Undetermined`=0)) %>% 
  rowwise() %>% 
  mutate(rich=sum(Exotic, Native, `Unknown/Undetermined`),
         propexotic=100*(Exotic/rich))

hf_exot <- left_join(veg_CSI_HF, 
                     hf_exot, 
                     by=c("Protocol", "Site", "Year", "totdist_percent")) %>% 
  select(-Exotic, -Native, -`Unknown/Undetermined`)
```

The prorportion of exotic species generally decreases with species richness (a), indicating that communities composed of few species are more likely to be composed of exotic species; perhaps in these communities exotic species are displacing native species. 

The prorportion of exotic species increases with development (b) and increases strongly with CSI (c). Figure b indicates that wetlands surrounded by more human develoment are more likely to include non-native species. Fgiure c indicates that highly specialized communities (i.e. those found at high and low disturbance intensities) are composed of a greater proportion of exotics than more generlized communities.

```{r exotic sp vs richness and HF and CSI}
p1 <- ggplot(hf_exot, aes(x=rich, propexotic)) +
  geom_point(alpha=0.5) +
  labs(x="Sp. Rich.", y="Exotic Sp. (%)")
p2 <- ggplot(hf_exot, aes(x=totdist_percent, propexotic)) +
  geom_point(alpha=0.5) +
  labs(x="Total Development (%)", y="Exotic Sp. (%)")
p3 <- ggplot(hf_exot, aes(x=CSI, propexotic)) +
  geom_point(alpha=0.5) +
  labs(y="Exotic Sp. (%)")
plot_grid(p1,p2,p3, nrow=1,ncol=3, labels="auto")
```

The figures below again indicate that communities at high devleopment intensities are composed of a greater proportion of exotic species, and that these communities are more specialized than communities at low develoment intensities. Species richness is not well predicted by development and the proportion of exotic species, although these are significant predictors. In contrast, both variables are strong predictors of CSI (development is the stronger predictor).

Together these results suggest that the responses of both species richness and CSI to total development can be explained by the proportion of exotic species in a community.

Note we need to statistically test whether we need a unique site ID random effect, and also how to handle any potentially differeces between Protocols. 

```{r rich and CSI x HF colored by exotics}
p4 <- ggplot(hf_exot, aes(x=totdist_percent, y=rich)) +
  geom_point(alpha=0.5, aes(color=propexotic)) +
  geom_smooth(method="lm", formula=y~poly(x,2), color=1, se=F) + 
  scale_color_gradient(low="yellow", high="red", name="% Exotics") +
  labs(x="Total Development (%)", y="Sp. Rich.") +
  annotate(geom="text", x=0, y=110, 
           label="Rich ~ poly(totdist_percent,2) + propexotic: \n R2 = 0.07 p<0.001", 
           size=5, hjust=0) +
  theme(legend.position = "top") 

p5 <- ggplot(hf_exot, aes(x=totdist_percent, y=CSI)) +
  geom_point(alpha=0.5, aes(color=propexotic)) +
  geom_smooth(method="lm", formula=y~poly(x,2), color=1, se=F) + 
  scale_color_gradient(low="yellow", high="red", name="% Exotics") +
  labs(x="Total Development (%)") +
  annotate(geom="text", x=0, y=1.8, 
           label="CSI ~ poly(totdist_percent,2) * propexotic + rich: \n R2 = 0.66 p<0.001", 
          size=5, hjust=0) +
  theme(legend.position = "top")

myleg <- get_legend(p4)
tmpp <- plot_grid(p4 + theme(legend.position="none"),
          p5 + theme(legend.position="none"), 
          nrow=2,ncol=1, labels="auto")
tmpp <- plot_grid(myleg, tmpp, nrow=2, ncol=1, rel_heights = c(0.2,1))
tmpp
```

